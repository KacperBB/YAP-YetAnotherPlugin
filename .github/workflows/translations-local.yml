name: ğŸŒ Translation Management (Local Only)

on:
  push:
    branches: [main, develop]
    paths:
      - 'includes/**/*.php'
      - 'languages/yap.pot'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  translations:
    name: ğŸ“‹ Generate & Compile Translations
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup WP CLI
        run: |
          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp
          wp --version
      
      - name: Install gettext tools
        run: sudo apt-get install -y gettext
      
      - name: Generate .pot template
        run: |
          wp i18n make-pot . languages/yap.pot \
            --exclude=node_modules,tests,old_version,.git,.github,vendor
          echo "âœ… Generated languages/yap.pot"
      
      - name: Compile .po files to .mo
        run: |
          for po_file in languages/*.po; do
            if [ -f "$po_file" ]; then
              wp i18n make-mo "$po_file" --mo-location=languages/
              lang=$(basename "$po_file" .po)
              echo "âœ… Compiled: $lang"
            fi
          done
      
      - name: Validate .po files
        run: |
          echo "ğŸ“Š Validation Results:"
          for po_file in languages/*.po; do
            if [ -f "$po_file" ]; then
              echo ""
              echo "Checking: $(basename $po_file)"
              msgfmt -c -o /dev/null "$po_file" && echo "âœ… Syntax OK" || echo "âŒ Syntax Error"
              
              total=$(grep -c "^msgid " "$po_file" || true)
              translated=$(grep -c 'msgstr "[^"]' "$po_file" || true)
              if [ $total -gt 0 ]; then
                percent=$((translated * 100 / total))
                echo "ğŸ“ˆ Coverage: $translated/$total ($percent%)"
              fi
            fi
          done
      
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'ğŸŒ Update translations (.pot + .mo compiled)'
          file_pattern: languages/yap.pot languages/*.mo
          commit_options: '--no-verify'
          skip_dirty_check: true
          disable_globbing: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Report
        run: |
          echo "âœ… Translation workflow completed!"
          echo ""
          echo "ğŸ“‚ Files:"
          ls -lah languages/
