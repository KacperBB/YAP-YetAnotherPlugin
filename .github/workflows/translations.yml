name: üåê Translation Management

on:
  push:
    branches: [main, develop]
    paths:
      - 'includes/**/*.php'
      - 'languages/yap.pot'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  generate-pot:
    name: üìã Generate .pot Template
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup WP CLI
        run: |
          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp
      
      - name: Generate .pot file
        run: |
          wp i18n make-pot . languages/yap.pot --exclude=node_modules,tests,old_version
      
      - name: Commit .pot changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'üåê Update translation template (yap.pot)'
          file_pattern: languages/yap.pot
          skip_dirty_check: true
          skip_fetch: false
  
  crowdin-sync:
    name: üîÑ Sync with Crowdin
    runs-on: ubuntu-latest
    needs: generate-pot
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Crowdin Upload (Strings)
        uses: crowdin/github-action@master
        with:
          config: crowdin.yml
          upload_sources: true
          upload_translations: false
          download_translations: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}
      
      - name: Crowdin Download (Translations)
        uses: crowdin/github-action@master
        with:
          config: crowdin.yml
          upload_sources: false
          upload_translations: false
          download_translations: true
          localization_branch_name: crowdin-translations
          create_pull_request: true
          pull_request_title: 'üåê New translations from Crowdin'
          pull_request_labels: translations
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}
  
  compile-mo:
    name: üî® Compile .mo Files
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup WP CLI
        run: |
          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp
      
      - name: Compile .po to .mo
        run: |
          for po_file in languages/*.po; do
            if [ -f "$po_file" ]; then
              wp i18n make-mo "$po_file" --mo-location=languages/
              echo "‚úÖ Compiled: $po_file"
            fi
          done
      
      - name: Commit .mo files
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'üî® Compile translation files (.mo)'
          file_pattern: languages/*.mo
          skip_dirty_check: true
  
  lint-translations:
    name: ‚úÖ Validate Translations
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Install gettext tools
        run: sudo apt-get install -y gettext
      
      - name: Validate .po files syntax
        run: |
          for po_file in languages/*.po; do
            if [ -f "$po_file" ]; then
              echo "Checking: $po_file"
              msgfmt -c -o /dev/null "$po_file"
              if [ $? -eq 0 ]; then
                echo "‚úÖ $po_file is valid"
              else
                echo "‚ùå $po_file has errors!"
                exit 1
              fi
            fi
          done
      
      - name: Check for missing translations
        run: |
          echo "üìä Translation Coverage:"
          for po_file in languages/*.po; do
            if [ -f "$po_file" ]; then
              total=$(grep -c "^msgid " "$po_file" || true)
              translated=$(grep -c 'msgstr "[^"]' "$po_file" || true)
              if [ $total -gt 0 ]; then
                percent=$((translated * 100 / total))
                lang=$(basename "$po_file" .po)
                echo "  $lang: $translated/$total ($percent%)"
              fi
            fi
          done
